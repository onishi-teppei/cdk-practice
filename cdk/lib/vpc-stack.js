"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.VpcStack = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const ec2 = require("aws-cdk-lib/aws-ec2");
const cdk = require("aws-cdk-lib");
// VPC Stackクラスを作成、StackはAWSリソースを管理するコンテナ
class VpcStack extends aws_cdk_lib_1.Stack {
    //scope: Construct型 - このスタックの親となるコンストラクト
    //id: string型 - スタックの一意な識別子
    //props: StackProps型（オプション） - スタックのプロパティ
    constructor(scope, id, props) {
        // 親コンストラクトを設定
        super(scope, id, props);
        const argContext = 'environment';
        const envKey = this.node.tryGetContext(argContext);
        if (envKey == undefined)
            throw new Error(`Please specify environment with context option. ex) cdk deploy -c ${argContext}=stg`);
        const context = this.node.tryGetContext(envKey);
        if (context == undefined)
            throw new Error('Invalid environment.');
        const vpc = new ec2.Vpc(this, `${context.AWSENV}-to2go-app-vpc`, {
            ipAddresses: ec2.IpAddresses.cidr(context.APPVPC_CIDR),
            maxAzs: 2,
            vpcName: `${context.AWSENV}-to2go-app-vpc`,
            subnetConfiguration: [],
        });
        // Internet Gateway
        const cfnInternetGateway = new ec2.CfnInternetGateway(this, `${context.AWSENV}-to2go-app-igw`, {
            tags: [{
                    key: 'Name',
                    value: `${context.AWSENV}-to2go-app-igw`,
                }],
        });
        // Internet GatewayをVPCにアタッチ
        const cfnVPCGatewayAttachment = new ec2.CfnVPCGatewayAttachment(this, `${context.AWSENV}-to2go-app-igw-attach`, {
            vpcId: vpc.vpcId,
            internetGatewayId: cfnInternetGateway.attrInternetGatewayId,
        });
        // パブリックルートテーブルを作成
        const publicRouteTable = new ec2.CfnRouteTable(this, `${context.AWSENV}-to2go-app-public-rtb`, {
            vpcId: vpc.vpcId,
            tags: [{ key: "Name", value: `${context.AWSENV}-to2go-app-public-rtb` }]
        });
        // パブリックルートテーブルにインターネットゲートウェイを設定
        const igwRoute = new ec2.CfnRoute(this, `${context.AWSENV}-to2go-app-public-rtb-igw`, {
            routeTableId: publicRouteTable.ref,
            destinationCidrBlock: "0.0.0.0/0",
            gatewayId: cfnInternetGateway.ref
        });
        // パブリックサブネットを作成
        const publicSubnet1a = new ec2.CfnSubnet(this, `${context.AWSENV}-to2go-app-public-subnet1c`, {
            vpcId: vpc.vpcId,
            availabilityZone: "ap-northeast-1c",
            cidrBlock: context.APPVPC_PUBSUB1,
            mapPublicIpOnLaunch: true,
            tags: [{ key: "Name", value: `${context.AWSENV}-to2go-app-public-subnet1` }]
        });
        // パブリックサブネットを作成
        const publicSubnet1c = new ec2.CfnSubnet(this, `${context.AWSENV}-to2go-app-public-subnet1d`, {
            vpcId: vpc.vpcId,
            availabilityZone: "ap-northeast-1d",
            cidrBlock: context.APPVPC_PUBSUB2,
            mapPublicIpOnLaunch: true,
            tags: [{ key: "Name", value: `${context.AWSENV}-to2go-app-public-subnet2` }]
        });
        // パブリックサブネットをルートテーブルにアタッチ
        const publicassociation1a = new ec2.CfnSubnetRouteTableAssociation(this, `${context.AWSENV}-to2go-app-public-rtb--association1c`, {
            routeTableId: publicRouteTable.ref,
            subnetId: publicSubnet1a.attrSubnetId,
        });
        // パブリックサブネットをルートテーブルにアタッチ
        const publicassociation1c = new ec2.CfnSubnetRouteTableAssociation(this, `${context.AWSENV}-to2go-app-public-rtb--association1d`, {
            routeTableId: publicRouteTable.ref,
            subnetId: publicSubnet1c.attrSubnetId,
        });
        // プライベートルートテーブルを作成
        const privateRouteTable = new ec2.CfnRouteTable(this, `${context.AWSENV}-to2go-app-private-rtb`, {
            vpcId: vpc.vpcId,
            tags: [{ key: "Name", value: `${context.AWSENV}-to2go-app-private-rtb` }]
        });
        // プライベートルートテーブルを出力
        new cdk.CfnOutput(this, 'privateRouteTableOutPut', {
            value: privateRouteTable.attrRouteTableId,
            exportName: 'appvpc-rtbId',
        });
        // プライベートサブネットを作成
        const privateSubnet1a = new ec2.CfnSubnet(this, `${context.AWSENV}-to2go-app-private-subnet1a`, {
            vpcId: vpc.vpcId,
            availabilityZone: "ap-northeast-1c",
            cidrBlock: context.APPVPC_PRISUB1,
            mapPublicIpOnLaunch: false,
            tags: [{ key: "Name", value: `${context.AWSENV}-to2go-app-private-subnet1` }]
        });
        const privateSubnet1c = new ec2.CfnSubnet(this, `${context.AWSENV}-to2go-app-private-subnet1c`, {
            vpcId: vpc.vpcId,
            availabilityZone: "ap-northeast-1d",
            cidrBlock: context.APPVPC_PRISUB2,
            mapPublicIpOnLaunch: false,
            tags: [{ key: "Name", value: `${context.AWSENV}-to2go-app-private-subnet2` }]
        });
        // プライベートサブネットをルートテーブルにアタッチ
        const privateassociation1a = new ec2.CfnSubnetRouteTableAssociation(this, `${context.AWSENV}-to2go-app-private-rtb-association1a`, {
            routeTableId: privateRouteTable.ref,
            subnetId: privateSubnet1a.attrSubnetId,
        });
        const privateassociation1c = new ec2.CfnSubnetRouteTableAssociation(this, `${context.AWSENV}-to2go-app-private-rtb-association1c`, {
            routeTableId: privateRouteTable.ref,
            subnetId: privateSubnet1c.attrSubnetId,
        });
        // Elastic IP
        const eip = new ec2.CfnEIP(this, `${context.AWSENV}-to2go-app-eip-natgw`, {
            tags: [{
                    key: 'Name',
                    value: `${context.AWSENV}-to2go-app-eip-natgw`,
                }],
        });
        // NAT Gateway
        const cfnNatGateway = new ec2.CfnNatGateway(this, `${context.AWSENV}-to2go-app-natgw`, {
            subnetId: publicSubnet1a.attrSubnetId,
            allocationId: eip.attrAllocationId,
            connectivityType: 'public',
            tags: [{
                    key: 'Name',
                    value: `${context.AWSENV}-to2go-app-natgw`,
                }],
        });
        // NAT Gateway route
        const natRoute = new ec2.CfnRoute(this, `${context.AWSENV}-to2go-app-private-rtb-nat`, {
            routeTableId: privateRouteTable.ref,
            destinationCidrBlock: "0.0.0.0/0",
            natGatewayId: cfnNatGateway.attrNatGatewayId,
        });
        // VPCフローログの設定
        // Log用S3取得
        // const accessLogsBucket = s3.Bucket.fromBucketName(this, "MyBucket", `${context.AWSENV}-to2go-app-s3-access-logs-bucket`);
        // vpc.addFlowLog('FlowLogS3', {
        //   destination: ec2.FlowLogDestination.toS3(accessLogsBucket,`vpc-flow-log/${context.AWSENV}-to2go-app-vpc/`)
        // });
    }
    ;
}
exports.VpcStack = VpcStack;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidnBjLXN0YWNrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidnBjLXN0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUFnRDtBQUVoRCwyQ0FBMkM7QUFFM0MsbUNBQW1DO0FBR25DLHlDQUF5QztBQUN6QyxNQUFhLFFBQVMsU0FBUSxtQkFBSztJQUlqQyx3Q0FBd0M7SUFDeEMsMkJBQTJCO0lBQzNCLHdDQUF3QztJQUN4QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQWtCO1FBQzFELGNBQWM7UUFDZCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUM7UUFDakMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDakQsSUFBSSxNQUFNLElBQUksU0FBUztZQUNyQixNQUFNLElBQUksS0FBSyxDQUFDLHFFQUFxRSxVQUFVLE1BQU0sQ0FBQyxDQUFDO1FBQzNHLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlDLElBQUksT0FBTyxJQUFJLFNBQVM7WUFDdEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBRTVDLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxPQUFPLENBQUMsTUFBTSxnQkFBZ0IsRUFBRTtZQUMvRCxXQUFXLEVBQUUsR0FBRyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQztZQUN0RCxNQUFNLEVBQUUsQ0FBQztZQUNULE9BQU8sRUFBRSxHQUFHLE9BQU8sQ0FBQyxNQUFNLGdCQUFnQjtZQUMxQyxtQkFBbUIsRUFBRSxFQUFFO1NBQ3hCLENBQUMsQ0FBQztRQUVILG1CQUFtQjtR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QixJQUFJLEVBQUUsQ0FBQztvQkFDTCxHQUFHLEVBQUUsTUFBTTtvQkFDWCxLQUFLLEVBQUUsR0FBRyxPQUFPLENBQUMsTUFBTSxrQkFBa0I7aUJBQzNDLENBQUM7U0FDSCxDQUFDLENBQUM7UUFFSCxvQkFBb0I7UUFDcEIsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxNQUFNLDRCQUE0QixFQUFFO1lBQ3JGLFlBQVksRUFBRSxpQkFBaUIsQ0FBQyxHQUFHO1lBQ25DLG9CQUFvQixFQUFFLFdBQVc7WUFDakMsWUFBWSxFQUFFLGFBQWEsQ0FBQyxnQkFBZ0I7U0FDN0MsQ0FBQyxDQUFDO1FBRUgsY0FBYztRQUNkLFdBQVc7UUFDWCw0SEFBNEg7UUFFNUgsZ0NBQWdDO1FBQ2hDLCtHQUErRztRQUMvRyxNQUFNO0lBQ1IsQ0FBQztJQUFBLENBQUM7Q0FDSDtBQTdKRCw0QkE2SkM7QUFBQSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3RhY2ssIFN0YWNrUHJvcHMgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCAqIGFzIGVjMiBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCB7VnBjfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBzMyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtczMnO1xuXG4vLyBWUEMgU3RhY2vjgq/jg6njgrnjgpLkvZzmiJDjgIFTdGFja+OBr0FXU+ODquOCveODvOOCueOCkueuoeeQhuOBmeOCi+OCs+ODs+ODhuODilxuZXhwb3J0IGNsYXNzIFZwY1N0YWNrIGV4dGVuZHMgU3RhY2sge1xuXG4gIHB1YmxpYyByZWFkb25seSB2cGM6IFZwYzsgLy8gcHVibGljIC0g5LuW44Gu44Kv44Op44K544GL44KJ44Ki44Kv44K744K55Y+v6IO9IHJlYWRvbmx5IC0g5LiA5bqm6Kit5a6a44GV44KM44Gf44KJ5aSJ5pu05LiN5Y+vIHZwYzogVnBjIC0gVlBD44K/44Kk44OX44Gu44OX44Ot44OR44OG44KjXG5cbiAgLy9zY29wZTogQ29uc3RydWN05Z6LIC0g44GT44Gu44K544K/44OD44Kv44Gu6Kaq44Go44Gq44KL44Kz44Oz44K544OI44Op44Kv44OIXG4gIC8vaWQ6IHN0cmluZ+WeiyAtIOOCueOCv+ODg+OCr+OBruS4gOaEj+OBquitmOWIpeWtkFxuICAvL3Byb3BzOiBTdGFja1Byb3Bz5Z6L77yI44Kq44OX44K344On44Oz77yJIC0g44K544K/44OD44Kv44Gu44OX44Ot44OR44OG44KjXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogU3RhY2tQcm9wcykge1xuICAgIC8vIOimquOCs+ODs+OCueODiOODqeOCr+ODiOOCkuioreWumlxuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgY29uc3QgYXJnQ29udGV4dCA9ICdlbnZpcm9ubWVudCc7XG4gICAgY29uc3QgZW52S2V5ID0gdGhpcy5ub2RlLnRyeUdldENvbnRleHQoYXJnQ29udGV4dCk7XG4gICAgICBpZiAoZW52S2V5ID09IHVuZGVmaW5lZClcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQbGVhc2Ugc3BlY2lmeSBlbnZpcm9ubWVudCB3aXRoIGNvbnRleHQgb3B0aW9uLiBleCkgY2RrIGRlcGxveSAtYyAke2FyZ0NvbnRleHR9PXN0Z2ApO1xuICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLm5vZGUudHJ5R2V0Q29udGV4dChlbnZLZXkpO1xuICAgICAgaWYgKGNvbnRleHQgPT0gdW5kZWZpbmVkKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZW52aXJvbm1lbnQuJyk7XG5cbiAgICBjb25zdCB2cGMgPSBuZXcgZWMyLlZwYyh0aGlzLCBgJHtjb250ZXh0LkFXU0VOVn0tdG8yZ28tYXBwLXZwY2AsIHtcbiAgICAgIGlwQWRkcmVzc2VzOiBlYzIuSXBBZGRyZXNzZXMuY2lkcihjb250ZXh0LkFQUFZQQ19DSURSKSxcbiAgICAgIG1heEF6czogMixcbiAgICAgIHZwY05hbWU6IGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtdnBjYCxcbiAgICAgIHN1Ym5ldENvbmZpZ3VyYXRpb246IFtdLFxuICAgIH0pO1xuXG4gICAgLy8gSW50ZXJuZXQgR2F0ZXdheVxuICAgIGNvbnN0IGNmbkludGVybmV0R2F0ZXdheSA9IG5ldyBlYzIuQ2ZuSW50ZXJuZXRHYXRld2F5KHRoaXMsIGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtaWd3YCwge1xuICAgICAgdGFnczogW3tcbiAgICAgICAga2V5OiAnTmFtZScsXG4gICAgICAgIHZhbHVlOiBgJHtjb250ZXh0LkFXU0VOVn0tdG8yZ28tYXBwLWlnd2AsXG4gICAgICB9XSxcbiAgICB9KTtcblxuICAgIC8vIEludGVybmV0IEdhdGV3YXnjgpJWUEPjgavjgqLjgr/jg4Pjg4FcbiAgICBjb25zdCBjZm5WUENHYXRld2F5QXR0YWNobWVudCA9IG5ldyBlYzIuQ2ZuVlBDR2F0ZXdheUF0dGFjaG1lbnQodGhpcywgYCR7Y29udGV4dC5BV1NFTlZ9LXRvMmdvLWFwcC1pZ3ctYXR0YWNoYCwge1xuICAgICAgdnBjSWQ6IHZwYy52cGNJZCxcbiAgICAgIGludGVybmV0R2F0ZXdheUlkOiBjZm5JbnRlcm5ldEdhdGV3YXkuYXR0ckludGVybmV0R2F0ZXdheUlkLFxuICAgIH0pO1xuXG4gICAgLy8g44OR44OW44Oq44OD44Kv44Or44O844OI44OG44O844OW44Or44KS5L2c5oiQXG4gICAgY29uc3QgcHVibGljUm91dGVUYWJsZSA9IG5ldyBlYzIuQ2ZuUm91dGVUYWJsZSh0aGlzLCBgJHtjb250ZXh0LkFXU0VOVn0tdG8yZ28tYXBwLXB1YmxpYy1ydGJgLCB7XG4gICAgICB2cGNJZDogdnBjLnZwY0lkLFxuICAgICAgdGFnczogW3sga2V5OiBcIk5hbWVcIiwgdmFsdWU6IGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtcHVibGljLXJ0YmAgfV1cbiAgICB9KTtcblxuICAgIC8vIOODkeODluODquODg+OCr+ODq+ODvOODiOODhuODvOODluODq+OBq+OCpOODs+OCv+ODvOODjeODg+ODiOOCsuODvOODiOOCpuOCp+OCpOOCkuioreWumlxuICAgIGNvbnN0IGlnd1JvdXRlID0gbmV3IGVjMi5DZm5Sb3V0ZSh0aGlzLCBgJHtjb250ZXh0LkFXU0VOVn0tdG8yZ28tYXBwLXB1YmxpYy1ydGItaWd3YCwge1xuICAgICAgcm91dGVUYWJsZUlkOiBwdWJsaWNSb3V0ZVRhYmxlLnJlZixcbiAgICAgIGRlc3RpbmF0aW9uQ2lkckJsb2NrOiBcIjAuMC4wLjAvMFwiLFxuICAgICAgZ2F0ZXdheUlkOiBjZm5JbnRlcm5ldEdhdGV3YXkucmVmXG4gICAgfSk7XG5cbiAgICAvLyDjg5Hjg5bjg6rjg4Pjgq/jgrXjg5bjg43jg4Pjg4jjgpLkvZzmiJBcbiAgICBjb25zdCBwdWJsaWNTdWJuZXQxYSA9IG5ldyBlYzIuQ2ZuU3VibmV0KHRoaXMsIGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtcHVibGljLXN1Ym5ldDFjYCwge1xuICAgICAgdnBjSWQ6IHZwYy52cGNJZCxcbiAgICAgIGF2YWlsYWJpbGl0eVpvbmU6IFwiYXAtbm9ydGhlYXN0LTFjXCIsXG4gICAgICBjaWRyQmxvY2s6IGNvbnRleHQuQVBQVlBDX1BVQlNVQjEsXG4gICAgICBtYXBQdWJsaWNJcE9uTGF1bmNoOiB0cnVlLFxuICAgICAgdGFnczogW3sga2V5OiBcIk5hbWVcIiwgdmFsdWU6IGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtcHVibGljLXN1Ym5ldDFgIH1dXG4gICAgfSk7XG5cbiAgICAvLyDjg5Hjg5bjg6rjg4Pjgq/jgrXjg5bjg43jg4Pjg4jjgpLkvZzmiJBcbiAgICBjb25zdCBwdWJsaWNTdWJuZXQxYyA9IG5ldyBlYzIuQ2ZuU3VibmV0KHRoaXMsIGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtcHVibGljLXN1Ym5ldDFkYCwge1xuICAgICAgdnBjSWQ6IHZwYy52cGNJZCxcbiAgICAgIGF2YWlsYWJpbGl0eVpvbmU6IFwiYXAtbm9ydGhlYXN0LTFkXCIsXG4gICAgICBjaWRyQmxvY2s6IGNvbnRleHQuQVBQVlBDX1BVQlNVQjIsXG4gICAgICBtYXBQdWJsaWNJcE9uTGF1bmNoOiB0cnVlLFxuICAgICAgdGFnczogW3sga2V5OiBcIk5hbWVcIiwgdmFsdWU6IGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtcHVibGljLXN1Ym5ldDJgIH1dXG4gICAgfSk7XG5cbiAgICAvLyDjg5Hjg5bjg6rjg4Pjgq/jgrXjg5bjg43jg4Pjg4jjgpLjg6vjg7zjg4jjg4bjg7zjg5bjg6vjgavjgqLjgr/jg4Pjg4FcbiAgICBjb25zdCBwdWJsaWNhc3NvY2lhdGlvbjFhID0gbmV3IGVjMi5DZm5TdWJuZXRSb3V0ZVRhYmxlQXNzb2NpYXRpb24odGhpcywgYCR7Y29udGV4dC5BV1NFTlZ9LXRvMmdvLWFwcC1wdWJsaWMtcnRiLS1hc3NvY2lhdGlvbjFjYCwge1xuICAgICAgcm91dGVUYWJsZUlkOiBwdWJsaWNSb3V0ZVRhYmxlLnJlZixcbiAgICAgIHN1Ym5ldElkOiBwdWJsaWNTdWJuZXQxYS5hdHRyU3VibmV0SWQsXG4gICAgfSk7XG5cbiAgICAvLyDjg5Hjg5bjg6rjg4Pjgq/jgrXjg5bjg43jg4Pjg4jjgpLjg6vjg7zjg4jjg4bjg7zjg5bjg6vjgavjgqLjgr/jg4Pjg4FcbiAgICBjb25zdCBwdWJsaWNhc3NvY2lhdGlvbjFjID0gbmV3IGVjMi5DZm5TdWJuZXRSb3V0ZVRhYmxlQXNzb2NpYXRpb24odGhpcywgYCR7Y29udGV4dC5BV1NFTlZ9LXRvMmdvLWFwcC1wdWJsaWMtcnRiLS1hc3NvY2lhdGlvbjFkYCwge1xuICAgICAgcm91dGVUYWJsZUlkOiBwdWJsaWNSb3V0ZVRhYmxlLnJlZixcbiAgICAgIHN1Ym5ldElkOiBwdWJsaWNTdWJuZXQxYy5hdHRyU3VibmV0SWQsXG4gICAgfSk7XG5cbiAgICAvLyDjg5fjg6njgqTjg5njg7zjg4jjg6vjg7zjg4jjg4bjg7zjg5bjg6vjgpLkvZzmiJBcbiAgICBjb25zdCBwcml2YXRlUm91dGVUYWJsZSA9IG5ldyBlYzIuQ2ZuUm91dGVUYWJsZSh0aGlzLCBgJHtjb250ZXh0LkFXU0VOVn0tdG8yZ28tYXBwLXByaXZhdGUtcnRiYCwge1xuICAgICAgdnBjSWQ6IHZwYy52cGNJZCxcbiAgICAgIHRhZ3M6IFt7IGtleTogXCJOYW1lXCIsIHZhbHVlOiBgJHtjb250ZXh0LkFXU0VOVn0tdG8yZ28tYXBwLXByaXZhdGUtcnRiYCB9XVxuICAgIH0pO1xuXG4gICAgLy8g44OX44Op44Kk44OZ44O844OI44Or44O844OI44OG44O844OW44Or44KS5Ye65YqbXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgJ3ByaXZhdGVSb3V0ZVRhYmxlT3V0UHV0Jywge1xuICAgICAgdmFsdWU6IHByaXZhdGVSb3V0ZVRhYmxlLmF0dHJSb3V0ZVRhYmxlSWQsXG4gICAgICBleHBvcnROYW1lOiAnYXBwdnBjLXJ0YklkJyxcbiAgICB9KTtcblxuICAgIC8vIOODl+ODqeOCpOODmeODvOODiOOCteODluODjeODg+ODiOOCkuS9nOaIkFxuICAgIGNvbnN0IHByaXZhdGVTdWJuZXQxYSA9IG5ldyBlYzIuQ2ZuU3VibmV0KHRoaXMsIGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtcHJpdmF0ZS1zdWJuZXQxYWAsIHtcbiAgICAgIHZwY0lkOiB2cGMudnBjSWQsXG4gICAgICBhdmFpbGFiaWxpdHlab25lOiBcImFwLW5vcnRoZWFzdC0xY1wiLFxuICAgICAgY2lkckJsb2NrOiBjb250ZXh0LkFQUFZQQ19QUklTVUIxLFxuICAgICAgbWFwUHVibGljSXBPbkxhdW5jaDogZmFsc2UsXG4gICAgICB0YWdzOiBbeyBrZXk6IFwiTmFtZVwiLCB2YWx1ZTogYCR7Y29udGV4dC5BV1NFTlZ9LXRvMmdvLWFwcC1wcml2YXRlLXN1Ym5ldDFgIH1dXG4gICAgfSk7XG5cbiAgICBjb25zdCBwcml2YXRlU3VibmV0MWMgPSBuZXcgZWMyLkNmblN1Ym5ldCh0aGlzLCBgJHtjb250ZXh0LkFXU0VOVn0tdG8yZ28tYXBwLXByaXZhdGUtc3VibmV0MWNgLCB7XG4gICAgICB2cGNJZDogdnBjLnZwY0lkLFxuICAgICAgYXZhaWxhYmlsaXR5Wm9uZTogXCJhcC1ub3J0aGVhc3QtMWRcIixcbiAgICAgIGNpZHJCbG9jazogY29udGV4dC5BUFBWUENfUFJJU1VCMixcbiAgICAgIG1hcFB1YmxpY0lwT25MYXVuY2g6IGZhbHNlLFxuICAgICAgdGFnczogW3sga2V5OiBcIk5hbWVcIiwgdmFsdWU6IGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtcHJpdmF0ZS1zdWJuZXQyYCB9XVxuICAgIH0pO1xuXG4gICAgLy8g44OX44Op44Kk44OZ44O844OI44K144OW44ON44OD44OI44KS44Or44O844OI44OG44O844OW44Or44Gr44Ki44K/44OD44OBXG4gICAgY29uc3QgcHJpdmF0ZWFzc29jaWF0aW9uMWEgPSBuZXcgZWMyLkNmblN1Ym5ldFJvdXRlVGFibGVBc3NvY2lhdGlvbih0aGlzLCBgJHtjb250ZXh0LkFXU0VOVn0tdG8yZ28tYXBwLXByaXZhdGUtcnRiLWFzc29jaWF0aW9uMWFgLCB7XG4gICAgICByb3V0ZVRhYmxlSWQ6IHByaXZhdGVSb3V0ZVRhYmxlLnJlZixcbiAgICAgIHN1Ym5ldElkOiBwcml2YXRlU3VibmV0MWEuYXR0clN1Ym5ldElkLFxuICAgIH0pO1xuXG4gICAgY29uc3QgcHJpdmF0ZWFzc29jaWF0aW9uMWMgPSBuZXcgZWMyLkNmblN1Ym5ldFJvdXRlVGFibGVBc3NvY2lhdGlvbih0aGlzLCBgJHtjb250ZXh0LkFXU0VOVn0tdG8yZ28tYXBwLXByaXZhdGUtcnRiLWFzc29jaWF0aW9uMWNgLCB7XG4gICAgICByb3V0ZVRhYmxlSWQ6IHByaXZhdGVSb3V0ZVRhYmxlLnJlZixcbiAgICAgIHN1Ym5ldElkOiBwcml2YXRlU3VibmV0MWMuYXR0clN1Ym5ldElkLFxuICAgIH0pO1xuXG4gICAgLy8gRWxhc3RpYyBJUFxuICAgIGNvbnN0IGVpcCA9IG5ldyBlYzIuQ2ZuRUlQKHRoaXMsIGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtZWlwLW5hdGd3YCx7XG4gICAgICB0YWdzOiBbe1xuICAgICAgICBrZXk6ICdOYW1lJyxcbiAgICAgICAgdmFsdWU6IGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtZWlwLW5hdGd3YCxcbiAgICAgIH1dLFxuICAgIH0pO1xuXG4gICAgLy8gTkFUIEdhdGV3YXlcbiAgICBjb25zdCBjZm5OYXRHYXRld2F5ID0gbmV3IGVjMi5DZm5OYXRHYXRld2F5KHRoaXMsIGAke2NvbnRleHQuQVdTRU5WfS10bzJnby1hcHAtbmF0Z3dgLCB7XG4gICAgICBzdWJuZXRJZDogcHVibGljU3VibmV0MWEuYXR0clN1Ym5ldElkLFxuICAgICAgYWxsb2NhdGlvbklkOiBlaXAuYXR0ckFsbG9jYXRpb25JZCxcbiAgICAgIGNvbm5lY3Rpdml0eVR5cGU6ICdwdWJsaWMnLFxuICAgICAgdGFnczogW3tcbiAgICAgICAga2V5OiAnTmFtZScsXG4gICAgICAgIHZhbHVlOiBgJHtjb250ZXh0LkFXU0VOVn0tdG8yZ28tYXBwLW5hdGd3YCxcbiAgICAgIH1dLFxuICAgIH0pO1xuXG4gICAgLy8gTkFUIEdhdGV3YXkgcm91dGVcbiAgICBjb25zdCBuYXRSb3V0ZSA9IG5ldyBlYzIuQ2ZuUm91dGUodGhpcywgYCR7Y29udGV4dC5BV1NFTlZ9LXRvMmdvLWFwcC1wcml2YXRlLXJ0Yi1uYXRgLCB7XG4gICAgICByb3V0ZVRhYmxlSWQ6IHByaXZhdGVSb3V0ZVRhYmxlLnJlZixcbiAgICAgIGRlc3RpbmF0aW9uQ2lkckJsb2NrOiBcIjAuMC4wLjAvMFwiLFxuICAgICAgbmF0R2F0ZXdheUlkOiBjZm5OYXRHYXRld2F5LmF0dHJOYXRHYXRld2F5SWQsXG4gICAgfSk7XG5cbiAgICAvLyBWUEPjg5Xjg63jg7zjg63jgrDjga7oqK3lrppcbiAgICAvLyBMb2fnlKhTM+WPluW+l1xuICAgIC8vIGNvbnN0IGFjY2Vzc0xvZ3NCdWNrZXQgPSBzMy5CdWNrZXQuZnJvbUJ1Y2tldE5hbWUodGhpcywgXCJNeUJ1Y2tldFwiLCBgJHtjb250ZXh0LkFXU0VOVn0tdG8yZ28tYXBwLXMzLWFjY2Vzcy1sb2dzLWJ1Y2tldGApO1xuXG4gICAgLy8gdnBjLmFkZEZsb3dMb2coJ0Zsb3dMb2dTMycsIHtcbiAgICAvLyAgIGRlc3RpbmF0aW9uOiBlYzIuRmxvd0xvZ0Rlc3RpbmF0aW9uLnRvUzMoYWNjZXNzTG9nc0J1Y2tldCxgdnBjLWZsb3ctbG9nLyR7Y29udGV4dC5BV1NFTlZ9LXRvMmdvLWFwcC12cGMvYClcbiAgICAvLyB9KTtcbiAgfTtcbn07XG4iXX0=